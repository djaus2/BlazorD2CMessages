@page "/"
@page "/fetchdata"
@using BlazorD2CMessages.Shared
@inject HttpClient Http

<h1>Monitor IoT Hub</h1>

<p>This component demonstrates fetching IoT Hub data via the server.</p>
<h3>Hub Connection Details in Environment Variables:</h3>
<small>EVENT_HUBS_COMPATIBILITY_ENDPOINT</small><br />
<small>EVENT_HUBS_COMPATIBILITY: Your service primary key</small> <br />
<small>SHARED_ACCESS_KEY_NAME</small><br />

@if (IsTimerRunning)
{
    <p><em><font color="blue">Running.</font>.</em></p>
}
else
{
    <p><em><font color="red">Not Running..</font></em></p>
}


<table class="table">
    <thead>
        <tr>
            <th>No.</th>
            <th>Id</th>
            <th>Sensor Type</th>
            <th>Value</th>
            <th>Values</th>
            <th>State</th>
            <th>TimeStamp</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><button @onclick="@( ()=>{IsTimerRunning = false;})">Stop</button></td>
            <td><button @onclick="@( ()=>{ Sensors = new List<Sensor>(); Refresh().GetAwaiter();})">Start</button></td>
            <td><button @onclick="@( ()=> { Sensors = new List<Sensor>(); })">Clear</button></td>
            <td><i>>Nb:</i> Autostarts</td><td> <i>Delay = @delay</i>.</td>
        </tr>
        @foreach (var sensor in Sensors)
        {
    <tr>
        <td>@sensor.No</td>
        <td>@sensor.Id</td>
        <td>@sensor.SensorType</td>
        <td>@sensor.Value</td>
        <td>@sensor.ValuesStr</td>
        <td>@sensor.State.</td>
        <td>@sensor.TimeStamp</td>
    </tr>
        }
    </tbody>
</table>



@code {
    private List<Sensor> Sensors;

    private int delay = 1;
    private int delayMax = 16;

    protected override void OnInitialized()
    {
        Sensors = new List<Sensor>();
        Refresh().GetAwaiter();
        base.OnInitialized();
    }

    bool IsTimerRunning = false;
    async Task Refresh()
    {
        delay = 1;
        IsTimerRunning = true;
        while (IsTimerRunning)
        {
            await Task.Delay(TimeSpan.FromSeconds(delay));
            if (IsTimerRunning)
            {
                var sensors = await Http.GetFromJsonAsync<Sensor[]>("Sensor");
                //if (sensors.Count() == 0)
                //{
                //    if (delay < delayMax)
                //        delay *=2;
                //}
                //else
                //{
                //    if (delay > 1)
                //        delay /= 2;
                //}
                delay = 1;
                Sensors.InsertRange(0,sensors);
                StateHasChanged();
            }

        }
    }


}
